<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    th:replace="~{layout/base :: html(title='Aide-Bibliothécaire | SIGTMA', activePage='dashboard', pageTitle='Référentiel & Support')}">

<head></head>

<body>
    <div th:fragment="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h5 class="fw-bold mb-0 text-forest">Aperçu du Référentiel</h5>
                <p class="text-muted extra-small mb-0">Données en temps réel de la bibliothèque</p>
            </div>
            <div class="d-flex gap-2">
                <span id="connectionStatus" class="badge bg-secondary rounded-pill d-flex align-items-center px-3"
                    style="font-size: 0.75rem;">
                    <i class="fas fa-circle me-2" style="font-size: 0.5rem;"></i> Initialisation...
                </span>
                <button class="btn btn-light btn-sm rounded-pill px-3 shadow-sm" onclick="refreshDashboard()"
                    style="font-size: 0.75rem;">
                    <i class="fas fa-sync-alt me-1"></i> Actualiser
                </button>
            </div>
        </div>
        <div class="row g-4 mb-4">
            <div class="col-md-6 col-xl-3">
                <div
                    class="card border-0 bg-emerald-vibrant text-white p-4 shadow-custom overflow-hidden position-relative h-100">
                    <div class="d-flex justify-content-between align-items-center position-relative"
                        style="z-index: 2;">
                        <div>
                            <p class="small mb-0 opacity-75 fw-medium">Étudiants Actifs</p>
                            <h2 class="fw-bold mb-0 mt-1" id="statEtudiants">0</h2>
                        </div>
                        <div class="bg-white bg-opacity-20 p-3 rounded-circle shadow-sm">
                            <i class="fas fa-user-graduate fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div
                    class="card border-0 bg-forest-gradient text-white p-4 shadow-custom overflow-hidden position-relative h-100">
                    <div class="d-flex justify-content-between align-items-center position-relative"
                        style="z-index: 2;">
                        <div>
                            <p class="small mb-0 opacity-75 fw-medium">Encadrants</p>
                            <h2 class="fw-bold mb-0 mt-1" id="statEncadrants">0</h2>
                        </div>
                        <div class="bg-white bg-opacity-20 p-3 rounded-circle shadow-sm">
                            <i class="fas fa-chalkboard-teacher fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div
                    class="card border-0 bg-mint-vibrant text-white p-4 shadow-custom overflow-hidden position-relative h-100">
                    <div class="d-flex justify-content-between align-items-center position-relative"
                        style="z-index: 2;">
                        <div>
                            <p class="small mb-0 opacity-75 fw-medium">Filières</p>
                            <h2 class="fw-bold mb-0 mt-1" id="statFilieres">0</h2>
                        </div>
                        <div class="bg-white bg-opacity-20 p-3 rounded-circle shadow-sm">
                            <i class="fas fa-university fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div
                    class="card border-0 bg-slate-dark text-white p-4 shadow-custom overflow-hidden position-relative h-100">
                    <div class="d-flex justify-content-between align-items-center position-relative"
                        style="z-index: 2;">
                        <div>
                            <p class="small mb-0 opacity-75 fw-medium">Dernières MàJ</p>
                            <h2 class="fw-bold mb-0 mt-1" id="statUpdates">0</h2>
                        </div>
                        <div class="bg-white bg-opacity-20 p-3 rounded-circle shadow-sm">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-7">
                <div class="card p-4 h-100 shadow-sm border-mint-soft">
                    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                        <h6 class="fw-bold mb-0 text-forest"><i class="fas fa-bolt text-emerald me-2"></i>Inscriptions
                            Récentes</h6>
                        <a href="#" class="btn btn-mint-light btn-sm rounded-pill px-3">Voir tout</a>
                    </div>
                    <div class="list-group list-group-flush" id="recentInscriptions">
                        <div class="text-center py-4 text-muted small">Chargement...</div>
                    </div>
                </div>
            </div>
            <div class="col-md-5">
                <div class="card p-4 h-100 shadow-sm border-mint-soft bg-mint-lightest">
                    <h6 class="fw-bold mb-4 text-forest">Centre d'Actions Rapides</h6>
                    <div class="d-grid gap-3">
                        <button class="btn btn-action-emerald" onclick="openDepotModal()">
                            <div class="bg-emerald p-2 rounded-3 me-3 text-white">
                                <i class="fas fa-plus-circle"></i>
                            </div>
                            <div class="text-start">
                                <span class="d-block fw-bold small text-emerald">Nouveau Dépôt</span>
                                <span class="d-block extra-small text-muted">Étudiant + Thèse + Encadrant</span>
                            </div>
                        </button>
                        <button class="btn btn-action-emerald" onclick="openEncadrantModal()">
                            <div class="bg-emerald p-2 rounded-3 me-3 text-white">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <div class="text-start">
                                <span class="d-block fw-bold small text-emerald">Nouveau Encadrant</span>
                                <span class="d-block extra-small text-muted">Mettre à jour l'annuaire</span>
                            </div>
                        </button>
                        <button class="btn btn-action-emerald" onclick="openEtudiantModal()">
                            <div class="bg-emerald p-2 rounded-3 me-3 text-white">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <div class="text-start">
                                <span class="d-block fw-bold small text-emerald">Nouvel Étudiant</span>
                                <span class="d-block extra-small text-muted">Ajouter dans le système</span>
                            </div>
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Modal Nouveau Dépôt -->
        <div class="modal fade" id="modalDepot" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 1.5rem;">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold text-forest">Enregistrer un Nouveau Dossier</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <form id="formDepot">
                            <div class="row g-3">
                                <!-- Section Étudiant -->
                                <div class="col-12">
                                    <h6 class="text-emerald fw-bold border-bottom pb-2">Informations Étudiant</h6>
                                </div>
                                <div class="col-12">
                                    <label class="small fw-medium mb-1">Étudiant</label>
                                    <div class="input-group mb-2">
                                        <input type="text" id="displayEtudiant" class="form-control"
                                            placeholder="Aucun étudiant sélectionné" readonly>
                                        <button class="btn btn-outline-emerald" type="button"
                                            onclick="openSelectEtudiantModal()">
                                            <i class="fas fa-search me-1"></i> Choisir
                                        </button>
                                        <input type="hidden" id="etudiantId" name="etudiantId">
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="checkNewEtudiant"
                                            onchange="toggleNewEtudiant()">
                                        <label class="form-check-label extra-small" for="checkNewEtudiant">
                                            Nouvel étudiant (si non trouvé dans la liste)
                                        </label>
                                    </div>
                                </div>
                                <div id="newEtudiantFields" class="row g-3 m-0 p-0">
                                    <div class="col-md-6">
                                        <label class="small fw-medium mb-1">Prénom</label>
                                        <input type="text" name="prenomEtudiant" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-medium mb-1">Nom</label>
                                        <input type="text" name="nomEtudiant" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-medium mb-1">Matricule</label>
                                        <input type="text" name="matriculeEtudiant" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-medium mb-1">Email</label>
                                        <input type="email" name="emailEtudiant" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-medium mb-1">Filière</label>
                                        <div class="input-group">
                                            <input type="text" id="displayFiliereNew" class="form-control"
                                                placeholder="Choisir..." readonly>
                                            <button class="btn btn-outline-secondary" type="button"
                                                onclick="openSelectFiliereModal('new')">
                                                <i class="fas fa-list"></i>
                                            </button>
                                            <input type="hidden" id="filiereIdNew" name="filiereId">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-medium mb-1">Année Académique</label>
                                        <input type="text" name="anneeAcademique" class="form-control"
                                            placeholder="2024-2025">
                                    </div>
                                </div>

                                <!-- Section Encadrant -->
                                <div class="col-12 mt-4">
                                    <h6 class="text-emerald fw-bold border-bottom pb-2">Informations Encadrant</h6>
                                </div>
                                <div class="col-12">
                                    <label class="small fw-medium mb-1">Encadrant</label>
                                    <div class="input-group mb-2">
                                        <input type="text" id="displayEncadrant" class="form-control"
                                            placeholder="Aucun encadrant sélectionné" readonly>
                                        <button class="btn btn-outline-emerald" type="button"
                                            onclick="openSelectEncadrantModal()">
                                            <i class="fas fa-search me-1"></i> Choisir
                                        </button>
                                        <input type="hidden" id="encadrantId" name="encadrantId">
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="checkNewEncadrant"
                                            onchange="toggleNewEncadrant()">
                                        <label class="form-check-label extra-small" for="checkNewEncadrant">
                                            Nouvel encadrant (si non trouvé)
                                        </label>
                                    </div>
                                </div>
                                <div id="newEncadrantFields" class="row g-3 m-0 p-0">
                                    <div class="col-md-4">
                                        <label class="small fw-medium mb-1">Prénom</label>
                                        <input type="text" name="prenomEncadrant" class="form-control">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small fw-medium mb-1">Nom</label>
                                        <input type="text" name="nomEncadrant" class="form-control">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small fw-medium mb-1">Email</label>
                                        <input type="email" name="emailEncadrant" class="form-control">
                                    </div>
                                    <div class="col-md-12">
                                        <label class="small fw-medium mb-1">Grade</label>
                                        <input type="text" name="gradeEncadrant" class="form-control"
                                            placeholder="Professeur, Docteur...">
                                    </div>
                                </div>

                                <!-- Section Thèse -->
                                <div class="col-12 mt-4">
                                    <h6 class="text-emerald fw-bold border-bottom pb-2">Détails du Travail</h6>
                                </div>
                                <div class="col-12">
                                    <label class="small fw-medium mb-1">Titre</label>
                                    <input type="text" name="titre" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="small fw-medium mb-1">Type</label>
                                    <select name="type" class="form-select" required>
                                        <option value="THESE">Thèse</option>
                                        <option value="MEMOIRE">Mémoire</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="small fw-medium mb-1">Année de Soutenance</label>
                                    <input type="number" name="annee" class="form-control" value="2025" required>
                                </div>
                                <div class="col-12">
                                    <label class="small fw-medium mb-1">Résumé</label>
                                    <textarea name="resume" class="form-control" rows="3"></textarea>
                                </div>
                                <div class="col-12">
                                    <label class="small fw-medium mb-1">Fichier PDF</label>
                                    <input type="file" name="fichierPdf" class="form-control" accept=".pdf" required>
                                </div>
                            </div>
                            <div class="text-end mt-4">
                                <button type="button" class="btn btn-light rounded-pill px-4"
                                    data-bs-dismiss="modal">Annuler</button>
                                <button type="submit"
                                    class="btn btn-emerald rounded-pill px-4 shadow-sm text-white">Enregistrer le
                                    Dépôt</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Sélection Étudiant (Pour Dossier) -->
        <div class="modal fade" id="modalSelectEtudiant" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem;">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold text-forest">Choisir un Étudiant</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <input type="text" id="searchInputEtudiant" class="form-control mb-3"
                            placeholder="Rechercher..." oninput="filterTable('tableSelectEtudiant', this.value)">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Prénom</th>
                                        <th>Nom</th>
                                        <th>Matricule</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="tableSelectEtudiantBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Sélection Encadrant (Pour Dossier) -->
        <div class="modal fade" id="modalSelectEncadrant" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem;">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold text-forest">Choisir un Encadrant</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <input type="text" id="searchInputEncadrant" class="form-control mb-3"
                            placeholder="Rechercher..." oninput="filterTable('tableSelectEncadrant', this.value)">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Prénom</th>
                                        <th>Nom</th>
                                        <th>Email</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="tableSelectEncadrantBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Sélection Filière (Pour Dossier) -->
        <div class="modal fade" id="modalSelectFiliere" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem;">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold text-forest">Choisir une Filière</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <input type="text" id="searchInputFiliere" class="form-control mb-3" placeholder="Rechercher..."
                            oninput="filterTable('tableSelectFiliere', this.value)">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="tableSelectFiliereBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Nouveau Encadrant (Standalone) -->
        <div class="modal fade" id="modalEncadrant" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 1.5rem;">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold text-forest">Ajouter un Encadrant</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <form id="formEncadrant">
                            <div class="mb-3">
                                <label class="small fw-medium mb-1">Prénom</label>
                                <input type="text" name="prenom" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="small fw-medium mb-1">Nom</label>
                                <input type="text" name="nom" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="small fw-medium mb-1">Email</label>
                                <input type="email" name="email" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="small fw-medium mb-1">Grade</label>
                                <input type="text" name="grade" class="form-control"
                                    placeholder="Professeur, Docteur..." required>
                            </div>
                            <div class="text-end mt-4">
                                <button type="button" class="btn btn-light rounded-pill px-4"
                                    data-bs-dismiss="modal">Annuler</button>
                                <button type="submit"
                                    class="btn btn-forest rounded-pill px-4 shadow-sm text-white">Ajouter</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Nouvel Étudiant (Standalone) -->
        <div class="modal fade" id="modalEtudiant" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 1.5rem;">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold text-forest">Ajouter un Étudiant</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <form id="formEtudiant">
                            <div class="mb-3">
                                <label class="small fw-medium mb-1">Prénom</label>
                                <input type="text" name="prenom" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="small fw-medium mb-1">Nom</label>
                                <input type="text" name="nom" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="small fw-medium mb-1">Matricule</label>
                                <input type="text" name="matricule" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="small fw-medium mb-1">Email</label>
                                <input type="email" name="email" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="small fw-medium mb-1">Filière</label>
                                <select id="selectFiliereEtudiant" name="filiereId" class="form-select" required>
                                    <option value="">Chargement...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="small fw-medium mb-1">Année Académique</label>
                                <input type="text" name="anneeAcademique" class="form-control" placeholder="2024-2025"
                                    required>
                            </div>
                            <div class="text-end mt-4">
                                <button type="button" class="btn btn-light rounded-pill px-4"
                                    data-bs-dismiss="modal">Annuler</button>
                                <button type="submit"
                                    class="btn btn-emerald rounded-pill px-4 shadow-sm text-white">Ajouter</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
            // Etat global pour la sélection de filière (Mode 'new student' dans dossier)
            let currentFiliereTargetId = null;
            let currentFiliereDisplayId = null;

            // --- Logique des Modals de Sélection (Tableaux) ---
            function openSelectEtudiantModal() {
                const modal = new bootstrap.Modal(document.getElementById('modalSelectEtudiant'));
                modal.show();
                loadSelectData('etudiants', 'tableSelectEtudiantBody');
            }

            function openSelectEncadrantModal() {
                const modal = new bootstrap.Modal(document.getElementById('modalSelectEncadrant'));
                modal.show();
                loadSelectData('encadrants', 'tableSelectEncadrantBody');
            }

            function openSelectFiliereModal(targetSuffix) {
                if (targetSuffix === 'new') {
                    currentFiliereTargetId = 'filiereIdNew';
                    currentFiliereDisplayId = 'displayFiliereNew';
                }
                const modal = new bootstrap.Modal(document.getElementById('modalSelectFiliere'));
                modal.show();
                loadSelectData('filieres', 'tableSelectFiliereBody');
            }

            function loadSelectData(type, tbodyId) {
                const tbody = document.getElementById(tbodyId);
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">Chargement...</td></tr>';

                fetch('/api/' + type)
                    .then(res => res.json())
                    .then(data => {
                        tbody.innerHTML = '';
                        window['rawData_' + type] = data;
                        renderTable(type, data, tbodyId);
                    });
            }

            function renderTable(type, data, tbodyId) {
                const tbody = document.getElementById(tbodyId);
                tbody.innerHTML = '';
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center">Aucune donnée</td></tr>';
                    return;
                }

                data.forEach(item => {
                    let row = '';
                    if (type === 'etudiants') {
                        row = `<td>${item.prenom}</td><td>${item.nom}</td><td>${item.matricule}</td>
                               <td><button class="btn btn-sm btn-outline-forest" onclick="selectItem('etudiant', ${item.id}, '${item.prenom} ${item.nom}')">Choisir</button></td>`;
                    } else if (type === 'encadrants') {
                        row = `<td>${item.prenom}</td><td>${item.nom}</td><td>${item.email}</td>
                               <td><button class="btn btn-sm btn-outline-forest" onclick="selectItem('encadrant', ${item.id}, '${item.prenom} ${item.nom}')">Choisir</button></td>`;
                    } else if (type === 'filieres') {
                        row = `<td>${item.nom}</td>
                               <td><button class="btn btn-sm btn-outline-forest" onclick="selectItem('filiere', ${item.id}, '${item.nom}')">Choisir</button></td>`;
                    }
                    tbody.innerHTML += `<tr>${row}</tr>`;
                });
            }

            function filterTable(tableId, query) {
                query = query.toLowerCase();
                const rows = document.querySelectorAll('#' + tableId + 'Body tr');
                rows.forEach(row => {
                    row.style.display = row.innerText.toLowerCase().includes(query) ? '' : 'none';
                });
            }

            function selectItem(type, id, nom) {
                if (type === 'etudiant') {
                    document.getElementById('etudiantId').value = id;
                    document.getElementById('displayEtudiant').value = nom;
                    document.getElementById('checkNewEtudiant').checked = false;
                    toggleNewEtudiant();
                    bootstrap.Modal.getInstance(document.getElementById('modalSelectEtudiant')).hide();
                } else if (type === 'encadrant') {
                    document.getElementById('encadrantId').value = id;
                    document.getElementById('displayEncadrant').value = nom;
                    document.getElementById('checkNewEncadrant').checked = false;
                    toggleNewEncadrant();
                    bootstrap.Modal.getInstance(document.getElementById('modalSelectEncadrant')).hide();
                } else if (type === 'filiere') {
                    if (currentFiliereTargetId) document.getElementById(currentFiliereTargetId).value = id;
                    if (currentFiliereDisplayId) document.getElementById(currentFiliereDisplayId).value = nom;
                    bootstrap.Modal.getInstance(document.getElementById('modalSelectFiliere')).hide();
                }
            }

            // --- Gestion des Modals Principaux ---

            function openDepotModal() {
                const modalEl = document.getElementById('modalDepot');
                if (modalEl) {
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                    // Reset fields for fresh entry
                    document.getElementById('checkNewEtudiant').checked = false; // Default: Select existing
                    toggleNewEtudiant();
                    document.getElementById('checkNewEncadrant').checked = false; // Default: Select existing
                    toggleNewEncadrant();

                    document.getElementById('displayEtudiant').value = '';
                    document.getElementById('displayEncadrant').value = '';
                    document.getElementById('etudiantId').value = '';
                    document.getElementById('encadrantId').value = '';
                }
            }

            function toggleNewEtudiant() {
                const check = document.getElementById('checkNewEtudiant');
                if (!check) return;
                const isNew = check.checked;
                const container = document.getElementById('newEtudiantFields');
                const displayInput = document.getElementById('displayEtudiant');

                if (container) {
                    container.style.display = isNew ? "flex" : "none";
                    const inputs = container.querySelectorAll('input, select');
                    inputs.forEach(i => {
                        if (i.id !== 'displayFiliereNew') i.required = isNew;
                    });
                }
            }

            function toggleNewEncadrant() {
                const check = document.getElementById('checkNewEncadrant');
                if (!check) return;
                const isNew = check.checked;
                const container = document.getElementById('newEncadrantFields');
                if (container) {
                    container.style.display = isNew ? "flex" : "none";
                    const inputs = container.querySelectorAll('input, select');
                    inputs.forEach(i => i.required = isNew);
                }
            }

            // Standalone Modals (From dashboard buttons)
            function openEncadrantModal() {
                const modalEl = document.getElementById('modalEncadrant');
                if (modalEl) new bootstrap.Modal(modalEl).show();
            }

            function openEtudiantModal() {
                const modalEl = document.getElementById('modalEtudiant');
                if (modalEl) {
                    const selFiliere = document.getElementById('selectFiliereEtudiant');
                    if (selFiliere) {
                        fetch('/api/filieres').then(r => r.json()).then(d => {
                            selFiliere.innerHTML = '<option value="">Choisir</option>';
                            d.forEach(f => selFiliere.innerHTML += `<option value="${f.id}">${f.nom}</option>`);
                        });
                    }
                    new bootstrap.Modal(modalEl).show();
                }
            }

            // --- Initialisation et Soumission ---

            document.addEventListener('DOMContentLoaded', function () {
                refreshDashboard();
                toggleNewEtudiant();
                toggleNewEncadrant();

                const form = document.getElementById('formDepot');
                if (form) {
                    form.addEventListener('submit', function (e) {
                        e.preventDefault();
                        updateStatus('Enregistrement...', 'warning');

                        const formData = new FormData();
                        const rawData = Object.fromEntries(new FormData(this).entries());

                        // Logic: If checkNewEtudiant is checked, we send explicit fields. 
                        // If not, we rely on etudiantId.
                        // The backend DossierDTO handles both.

                        const dossierObj = {
                            etudiantId: (!document.getElementById('checkNewEtudiant').checked && rawData.etudiantId) ? parseInt(rawData.etudiantId) : null,
                            encadrantId: (!document.getElementById('checkNewEncadrant').checked && rawData.encadrantId) ? parseInt(rawData.encadrantId) : null,
                            titre: rawData.titre,
                            type: rawData.type,
                            annee: parseInt(rawData.annee),
                            resume: rawData.resume,
                            // New fields
                            nomEtudiant: rawData.nomEtudiant,
                            prenomEtudiant: rawData.prenomEtudiant,
                            matriculeEtudiant: rawData.matriculeEtudiant,
                            emailEtudiant: rawData.emailEtudiant,
                            filiereId: rawData.filiereId ? parseInt(rawData.filiereId) : null,
                            anneeAcademique: rawData.anneeAcademique,
                            nomEncadrant: rawData.nomEncadrant,
                            prenomEncadrant: rawData.prenomEncadrant,
                            emailEncadrant: rawData.emailEncadrant,
                            gradeEncadrant: rawData.gradeEncadrant
                        };

                        formData.append('dossier', JSON.stringify(dossierObj));
                        const fileInput = this.querySelector('input[name="fichierPdf"]');
                        if (fileInput.files.length > 0) {
                            formData.append('fichier', fileInput.files[0]);
                        }

                        fetch('/api/theses/depot', {
                            method: 'POST',
                            body: formData
                        })
                            .then(res => {
                                if (res.ok) {
                                    alert('Succès ! Dossier déposé.');
                                    location.reload();
                                } else {
                                    return res.text().then(text => { throw new Error(text || res.statusText) });
                                }
                            })
                            .catch(err => {
                                alert('Erreur : ' + err.message);
                                updateStatus('Connecté', 'success');
                            });
                    });
                }

                // Add handlers for formEtudiant and formEncadrant (Standalone)
                const formEtu = document.getElementById('formEtudiant');
                if (formEtu) {
                    formEtu.addEventListener('submit', function (e) {
                        e.preventDefault();
                        const data = Object.fromEntries(new FormData(this));

                        const payload = {
                            prenom: data.prenom,
                            nom: data.nom,
                            matricule: data.matricule,
                            email: data.email,
                            anneeAcademique: data.anneeAcademique,
                            filiere: { id: parseInt(data.filiereId) }
                        };

                        fetch('/api/etudiants', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        }).then(r => {
                            if (r.ok) { alert('Étudiant ajouté'); location.reload(); }
                            else alert('Erreur ajout étudiant');
                        });
                    });
                }

                const formEnc = document.getElementById('formEncadrant');
                if (formEnc) {
                    formEnc.addEventListener('submit', function (e) {
                        e.preventDefault();
                        const data = Object.fromEntries(new FormData(this));
                        fetch('/api/encadrants', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        }).then(r => {
                            if (r.ok) { alert('Encadrant ajouté'); location.reload(); }
                            else alert('Erreur ajout encadrant');
                        });
                    });
                }
            });

            function updateStatus(text, color) {
                const el = document.getElementById('connectionStatus');
                if (el) {
                    el.className = `badge bg-${color} rounded-pill d-flex align-items-center px-3 shadow-sm`;
                    el.innerHTML = `<i class="fas fa-circle me-2" style="font-size: 0.5rem;"></i> ${text}`;
                }
            }

            function refreshDashboard() {
                const cacheBust = '?t=' + Date.now();
                fetch('/api/aide/stats/summary' + cacheBust).then(r => r.json()).then(data => {
                    document.getElementById('statEtudiants').innerText = data.totalEtudiants;
                    document.getElementById('statEncadrants').innerText = data.totalEncadrants;
                    document.getElementById('statFilieres').innerText = data.totalFilieres;
                    document.getElementById('statUpdates').innerText = data.todayUpdates;

                    const container = document.getElementById('recentInscriptions');
                    if (container) {
                        container.innerHTML = '';
                        if (!data.recentDeposits || data.recentDeposits.length === 0) {
                            container.innerHTML = '<div class="text-center py-4 text-muted">Aucun dépôt récent.</div>';
                        } else {
                            data.recentDeposits.forEach(d => {
                                const initials = d.nomEtudiant ? d.nomEtudiant.split(' ').map(n => n[0]).join('').toUpperCase() : '??';
                                container.innerHTML += `
                                    <div class="list-group-item px-0 border-0 py-3 d-flex justify-content-between align-items-center transition-hover">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-emerald me-3 shadow-sm">${initials}</div>
                                            <div>
                                                <p class="small fw-bold mb-0 text-forest">${d.nomEtudiant}</p>
                                                <p class="extra-small text-muted mb-0">${d.filiere}</p>
                                            </div>
                                        </div>
                                        <span class="badge bg-mint-lightest text-forest extra-small border-mint-soft">${d.date}</span>
                                    </div>
                                `;
                            });
                        }
                    }
                    updateStatus('Connecté', 'success');
                }).catch(err => {
                    console.error(err);
                    updateStatus('Erreur API', 'danger');
                });
            }

        </script>
    </div>
</body>

</html>