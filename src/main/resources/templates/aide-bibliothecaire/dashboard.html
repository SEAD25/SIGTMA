<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    th:replace="~{layout/base :: html(title='Aide-Bibliothécaire | SIGTMA', activePage='dashboard', pageTitle='Référentiel & Support')}">

<head></head>

<body>
    <div th:fragment="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h5 class="fw-bold mb-0 text-forest">Aperçu du Référentiel</h5>
                <p class="text-muted extra-small mb-0">Données en temps réel de la bibliothèque</p>
            </div>
            <div class="d-flex gap-2">
                <span id="connectionStatus" class="badge bg-secondary rounded-pill d-flex align-items-center px-3"
                    style="font-size: 0.75rem;">
                    <i class="fas fa-circle me-2" style="font-size: 0.5rem;"></i> Initialisation...
                </span>
                <button class="btn btn-light btn-sm rounded-pill px-3 shadow-sm" onclick="refreshDashboard()"
                    style="font-size: 0.75rem;">
                    <i class="fas fa-sync-alt me-1"></i> Actualiser
                </button>
            </div>
        </div>
        <div class="row g-4 mb-4">
            <div class="col-md-6 col-xl-3">
                <div
                    class="card border-0 bg-emerald-vibrant text-white p-4 shadow-custom overflow-hidden position-relative h-100">
                    <div class="d-flex justify-content-between align-items-center position-relative"
                        style="z-index: 2;">
                        <div>
                            <p class="small mb-0 opacity-75 fw-medium">Étudiants Actifs</p>
                            <h2 class="fw-bold mb-0 mt-1" id="statEtudiants">0</h2>
                        </div>
                        <div class="bg-white bg-opacity-20 p-3 rounded-circle shadow-sm">
                            <i class="fas fa-user-graduate fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div
                    class="card border-0 bg-forest-gradient text-white p-4 shadow-custom overflow-hidden position-relative h-100">
                    <div class="d-flex justify-content-between align-items-center position-relative"
                        style="z-index: 2;">
                        <div>
                            <p class="small mb-0 opacity-75 fw-medium">Encadrants</p>
                            <h2 class="fw-bold mb-0 mt-1" id="statEncadrants">0</h2>
                        </div>
                        <div class="bg-white bg-opacity-20 p-3 rounded-circle shadow-sm">
                            <i class="fas fa-chalkboard-teacher fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div
                    class="card border-0 bg-mint-vibrant text-white p-4 shadow-custom overflow-hidden position-relative h-100">
                    <div class="d-flex justify-content-between align-items-center position-relative"
                        style="z-index: 2;">
                        <div>
                            <p class="small mb-0 opacity-75 fw-medium">Filières</p>
                            <h2 class="fw-bold mb-0 mt-1" id="statFilieres">0</h2>
                        </div>
                        <div class="bg-white bg-opacity-20 p-3 rounded-circle shadow-sm">
                            <i class="fas fa-university fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div
                    class="card border-0 bg-slate-dark text-white p-4 shadow-custom overflow-hidden position-relative h-100">
                    <div class="d-flex justify-content-between align-items-center position-relative"
                        style="z-index: 2;">
                        <div>
                            <p class="small mb-0 opacity-75 fw-medium">Dernières MàJ</p>
                            <h2 class="fw-bold mb-0 mt-1" id="statUpdates">0</h2>
                        </div>
                        <div class="bg-white bg-opacity-20 p-3 rounded-circle shadow-sm">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-7">
                <div class="card p-4 h-100 shadow-sm border-mint-soft">
                    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                        <h6 class="fw-bold mb-0 text-forest"><i class="fas fa-bolt text-emerald me-2"></i>Inscriptions
                            Récentes</h6>
                        <a href="#" class="btn btn-mint-light btn-sm rounded-pill px-3">Voir tout</a>
                    </div>
                    <div class="list-group list-group-flush" id="recentInscriptions">
                        <div class="text-center py-4 text-muted small">Chargement...</div>
                    </div>
                </div>
            </div>
            <div class="col-md-5">
                <div class="card p-4 h-100 shadow-sm border-mint-soft bg-mint-lightest">
                    <h6 class="fw-bold mb-4 text-forest">Centre d'Actions Rapides</h6>
                    <div class="d-grid gap-3">
                        <button class="btn btn-action-emerald" onclick="openDepotModal()">
                            <div class="bg-emerald p-2 rounded-3 me-3 text-white">
                                <i class="fas fa-plus-circle"></i>
                            </div>
                            <div class="text-start">
                                <span class="d-block fw-bold small text-emerald">Nouveau Dépôt</span>
                                <span class="d-block extra-small text-muted">Étudiant + Thèse + Encadrant</span>
                            </div>
                        </button>
                        <button class="btn btn-action-emerald" onclick="openEncadrantModal()">
                            <div class="bg-emerald p-2 rounded-3 me-3 text-white">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <div class="text-start">
                                <span class="d-block fw-bold small text-emerald">Nouveau Encadrant</span>
                                <span class="d-block extra-small text-muted">Mettre à jour l'annuaire</span>
                            </div>
                        </button>
                        <button class="btn btn-action-emerald" onclick="openEtudiantModal()">
                            <div class="bg-emerald p-2 rounded-3 me-3 text-white">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <div class="text-start">
                                <span class="d-block fw-bold small text-emerald">Nouvel Étudiant</span>
                                <span class="d-block extra-small text-muted">Ajouter dans le système</span>
                            </div>
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Modal Nouveau Dépôt -->
        <div class="modal fade" id="modalDepot" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 1.5rem;">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold text-forest">Enregistrer un Nouveau Dossier</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <form id="formDepot">
                            <div class="row g-3">
                                <!-- Section Étudiant -->
                                <div class="col-12">
                                    <h6 class="text-emerald fw-bold border-bottom pb-2">Informations Étudiant</h6>
                                </div>
                                <div class="col-12">
                                    <label class="small fw-medium mb-1">Choisir un Étudiant Existant</label>
                                    <select id="selectEtudiant" name="etudiantId" class="form-select mb-2"
                                        onchange="toggleEtudiantFields()">
                                        <option value="">-- Nouvel Étudiant --</option>
                                        <option value="">Chargement...</option>
                                    </select>
                                </div>
                                <div id="newEtudiantFields" class="row g-3 m-0 p-0">
                                    <div class="col-md-6">
                                        <label class="small fw-medium mb-1">Prénom</label>
                                        <input type="text" name="prenomEtudiant" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-medium mb-1">Nom</label>
                                        <input type="text" name="nomEtudiant" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-medium mb-1">Matricule</label>
                                        <input type="text" name="matriculeEtudiant" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-medium mb-1">Email</label>
                                        <input type="email" name="emailEtudiant" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-medium mb-1">Filière</label>
                                        <select id="selectFiliere" name="filiereId" class="form-select">
                                            <option value="">Chargement...</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-medium mb-1">Année Académique</label>
                                        <input type="text" name="anneeAcademique" class="form-control"
                                            placeholder="2024-2025">
                                    </div>
                                </div>

                                <!-- Section Encadrant -->
                                <div class="col-12 mt-4">
                                    <h6 class="text-emerald fw-bold border-bottom pb-2">Informations Encadrant</h6>
                                </div>
                                <div class="col-12">
                                    <label class="small fw-medium mb-1">Choisir un Encadrant Existant</label>
                                    <select id="selectEncadrant" name="encadrantId" class="form-select mb-2"
                                        onchange="toggleEncadrantFields()">
                                        <option value="">-- Nouvel Encadrant --</option>
                                        <option value="">Chargement...</option>
                                    </select>
                                </div>
                                <div id="newEncadrantFields" class="row g-3 m-0 p-0">
                                    <div class="col-md-4">
                                        <label class="small fw-medium mb-1">Prénom</label>
                                        <input type="text" name="prenomEncadrant" class="form-control">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small fw-medium mb-1">Nom</label>
                                        <input type="text" name="nomEncadrant" class="form-control">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small fw-medium mb-1">Email</label>
                                        <input type="email" name="emailEncadrant" class="form-control">
                                    </div>
                                    <div class="col-md-12">
                                        <label class="small fw-medium mb-1">Grade</label>
                                        <input type="text" name="gradeEncadrant" class="form-control"
                                            placeholder="Professeur, Docteur...">
                                    </div>
                                </div>

                                <!-- Section Thèse -->
                                <div class="col-12 mt-4">
                                    <h6 class="text-emerald fw-bold border-bottom pb-2">Détails du Travail</h6>
                                </div>
                                <div class="col-12">
                                    <label class="small fw-medium mb-1">Titre</label>
                                    <input type="text" name="titre" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="small fw-medium mb-1">Type</label>
                                    <select name="type" class="form-select" required>
                                        <option value="THESE">Thèse</option>
                                        <option value="MEMOIRE">Mémoire</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="small fw-medium mb-1">Année de Soutenance</label>
                                    <input type="number" name="annee" class="form-control" value="2025" required>
                                </div>
                                <div class="col-12">
                                    <label class="small fw-medium mb-1">Résumé</label>
                                    <textarea name="resume" class="form-control" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="text-end mt-4">
                                <button type="button" class="btn btn-light rounded-pill px-4"
                                    data-bs-dismiss="modal">Annuler</button>
                                <button type="submit"
                                    class="btn btn-emerald rounded-pill px-4 shadow-sm text-white">Enregistrer le
                                    Dépôt</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Nouveau Encadrant -->
        <div class="modal fade" id="modalEncadrant" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 1.5rem;">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold text-forest">Ajouter un Encadrant</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <form id="formEncadrant">
                            <div class="mb-3">
                                <label class="small fw-medium mb-1">Prénom</label>
                                <input type="text" name="prenom" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="small fw-medium mb-1">Nom</label>
                                <input type="text" name="nom" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="small fw-medium mb-1">Email</label>
                                <input type="email" name="email" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="small fw-medium mb-1">Grade</label>
                                <input type="text" name="grade" class="form-control"
                                    placeholder="Professeur, Docteur..." required>
                            </div>
                            <div class="text-end mt-4">
                                <button type="button" class="btn btn-light rounded-pill px-4"
                                    data-bs-dismiss="modal">Annuler</button>
                                <button type="submit"
                                    class="btn btn-forest rounded-pill px-4 shadow-sm text-white">Ajouter</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Nouvel Étudiant -->
        <div class="modal fade" id="modalEtudiant" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 1.5rem;">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold text-forest">Ajouter un Étudiant</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <form id="formEtudiant">
                            <div class="mb-3">
                                <label class="small fw-medium mb-1">Prénom</label>
                                <input type="text" name="prenom" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="small fw-medium mb-1">Nom</label>
                                <input type="text" name="nom" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="small fw-medium mb-1">Matricule</label>
                                <input type="text" name="matricule" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="small fw-medium mb-1">Email</label>
                                <input type="email" name="email" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="small fw-medium mb-1">Filière</label>
                                <select id="selectFiliereEtudiant" name="filiereId" class="form-select" required>
                                    <option value="">Chargement...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="small fw-medium mb-1">Année Académique</label>
                                <input type="text" name="anneeAcademique" class="form-control" placeholder="2024-2025"
                                    required>
                            </div>
                            <div class="text-end mt-4">
                                <button type="button" class="btn btn-light rounded-pill px-4"
                                    data-bs-dismiss="modal">Annuler</button>
                                <button type="submit"
                                    class="btn btn-emerald rounded-pill px-4 shadow-sm text-white">Ajouter</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
            function openDepotModal() {
                const modalEl = document.getElementById('modalDepot');
                if (modalEl) {
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                }
            }

            function openEncadrantModal() {
                const modalEl = document.getElementById('modalEncadrant');
                if (modalEl) {
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                }
            }

            function openEtudiantModal() {
                const modalEl = document.getElementById('modalEtudiant');
                if (modalEl) {
                    // Charger les filières avant d'ouvrir le modal
                    const selFiliere = document.getElementById('selectFiliereEtudiant');
                    if (selFiliere) {
                        fetch('/api/filieres')
                            .then(res => res.json())
                            .then(data => {
                                selFiliere.innerHTML = '<option value="">Choisir une filière</option>';
                                data.forEach(f => selFiliere.innerHTML += `<option value="${f.id}">${f.nom}</option>`);
                            });
                    }
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                }
            }

            function toggleEtudiantFields() {
                const val = document.getElementById('selectEtudiant').value;
                const container = document.getElementById('newEtudiantFields');
                if (container) {
                    container.style.display = val === "" ? "flex" : "none";
                    const inputs = container.querySelectorAll('input, select');
                    inputs.forEach(i => i.required = (val === ""));
                }
            }

            function toggleEncadrantFields() {
                const val = document.getElementById('selectEncadrant').value;
                const container = document.getElementById('newEncadrantFields');
                if (container) {
                    container.style.display = val === "" ? "flex" : "none";
                    const inputs = container.querySelectorAll('input, select');
                    inputs.forEach(i => i.required = (val === ""));
                }
            }

            function updateStatus(text, color) {
                const el = document.getElementById('connectionStatus');
                if (el) {
                    el.className = `badge bg-${color} rounded-pill d-flex align-items-center px-3 shadow-sm`;
                    el.innerHTML = `<i class="fas fa-circle me-2" style="font-size: 0.5rem;"></i> ${text}`;
                }
            }

            function refreshDashboard() {
                updateStatus('Chargement...', 'info');

                const cacheBust = '?t=' + Date.now();

                // 1. Statistiques
                fetch('/api/aide/stats/summary' + cacheBust)
                    .then(res => {
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        return res.json();
                    })
                    .then(data => {
                        document.getElementById('statEtudiants').innerText = data.totalEtudiants;
                        document.getElementById('statEncadrants').innerText = data.totalEncadrants;
                        document.getElementById('statFilieres').innerText = data.totalFilieres;
                        document.getElementById('statUpdates').innerText = data.todayUpdates;

                        const container = document.getElementById('recentInscriptions');
                        if (container) {
                            container.innerHTML = '';
                            if (!data.recentDeposits || data.recentDeposits.length === 0) {
                                container.innerHTML = '<div class="text-center py-4 text-muted">Aucun dépôt récent.</div>';
                            } else {
                                data.recentDeposits.forEach(d => {
                                    const initials = d.nomEtudiant ? d.nomEtudiant.split(' ').map(n => n[0]).join('').toUpperCase() : '??';
                                    container.innerHTML += `
                                        <div class="list-group-item px-0 border-0 py-3 d-flex justify-content-between align-items-center transition-hover">
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-emerald me-3 shadow-sm">${initials}</div>
                                                <div>
                                                    <p class="small fw-bold mb-0 text-forest">${d.nomEtudiant}</p>
                                                    <p class="extra-small text-muted mb-0">${d.filiere}</p>
                                                </div>
                                            </div>
                                            <span class="badge bg-mint-lightest text-forest extra-small border-mint-soft">${d.date}</span>
                                        </div>
                                    `;
                                });
                            }
                        }
                        updateStatus('Connecté', 'success');
                    })
                    .catch(err => {
                        console.error('Erreur stats:', err);
                        updateStatus('Erreur API', 'danger');
                    });

                // 2. Filières
                fetch('/api/filieres' + cacheBust)
                    .then(res => res.json())
                    .then(data => {
                        const sel = document.getElementById('selectFiliere');
                        if (sel) {
                            sel.innerHTML = '<option value="">Choisir une filière</option>';
                            data.forEach(f => sel.innerHTML += `<option value="${f.id}">${f.nom}</option>`);
                        }
                    })
                    .catch(err => console.error('Erreur filières:', err));

                // 3. Étudiants
                fetch('/api/etudiants' + cacheBust)
                    .then(res => res.json())
                    .then(data => {
                        const sel = document.getElementById('selectEtudiant');
                        if (sel) {
                            sel.innerHTML = '<option value="">-- Nouvel Étudiant --</option>';
                            data.forEach(e => sel.innerHTML += `<option value="${e.id}">${e.prenom} ${e.nom} (${e.matricule})</option>`);
                        }
                    })
                    .catch(err => console.error('Erreur étudiants:', err));

                // 4. Encadrants
                fetch('/api/encadrants' + cacheBust)
                    .then(res => res.json())
                    .then(data => {
                        const sel = document.getElementById('selectEncadrant');
                        if (sel) {
                            sel.innerHTML = '<option value="">-- Nouvel Encadrant --</option>';
                            data.forEach(e => sel.innerHTML += `<option value="${e.id}">${e.prenom} ${e.nom} (${e.grade})</option>`);
                        }
                    })
                    .catch(err => console.error('Erreur encadrants:', err));
            }

            document.addEventListener('DOMContentLoaded', function () {
                refreshDashboard();
                const form = document.getElementById('formDepot');
                if (form) {
                    form.addEventListener('submit', function (e) {
                        e.preventDefault();
                        updateStatus('Enregistrement...', 'warning');
                        const formData = new FormData(this);
                        const data = Object.fromEntries(formData.entries());

                        if (data.etudiantId) data.etudiantId = parseInt(data.etudiantId);
                        else delete data.etudiantId;
                        if (data.encadrantId) data.encadrantId = parseInt(data.encadrantId);
                        else delete data.encadrantId;
                        if (data.filiereId) data.filiereId = parseInt(data.filiereId);
                        data.annee = parseInt(data.annee);

                        fetch('/api/theses/depot', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        })
                            .then(res => {
                                if (res.ok) {
                                    alert('Succès !');
                                    location.reload();
                                } else {
                                    throw new Error(`Dépôt échoué (${res.status})`);
                                }
                            })
                            .catch(err => {
                                alert('Erreur : ' + err.message);
                                updateStatus('Connecté', 'success');
                            });
                    });
                }

                // Gérer l'ajout d'encadrant
                const formEnc = document.getElementById('formEncadrant');
                if (formEnc) {
                    formEnc.addEventListener('submit', function (e) {
                        e.preventDefault();
                        updateStatus('Enregistrement...', 'warning');
                        const formData = new FormData(this);
                        const data = Object.fromEntries(formData.entries());

                        fetch('/api/encadrants', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        })
                            .then(res => {
                                if (res.ok) {
                                    alert('Encadrant ajouté avec succès !');
                                    location.reload();
                                } else {
                                    throw new Error('Erreur lors de l\'ajout');
                                }
                            })
                            .catch(err => {
                                alert(err.message);
                                updateStatus('Connecté', 'success');
                            });
                    });
                }

                // Gérer l'ajout d'étudiant
                const formEtu = document.getElementById('formEtudiant');
                if (formEtu) {
                    formEtu.addEventListener('submit', function (e) {
                        e.preventDefault();
                        updateStatus('Enregistrement...', 'warning');
                        const formData = new FormData(this);
                        const data = Object.fromEntries(formData.entries());

                        // Convertir filiereId en objet filiere
                        if (data.filiereId) {
                            data.filiere = { id: parseInt(data.filiereId) };
                            delete data.filiereId;
                        }

                        fetch('/api/etudiants', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        })
                            .then(res => {
                                if (res.ok) {
                                    alert('Étudiant ajouté avec succès !');
                                    location.reload();
                                } else {
                                    throw new Error('Erreur lors de l\'ajout');
                                }
                            })
                            .catch(err => {
                                alert(err.message);
                                updateStatus('Connecté', 'success');
                            });
                    });
                }
            });
        </script>
    </div>
</body>

</html>