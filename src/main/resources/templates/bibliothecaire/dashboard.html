<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    th:replace="~{layout/base :: html(title='Bibliothécaire | SIGTMA', activePage='dashboard', pageTitle='Gestion Documentaire')}">

<head></head>

<body>
    <div th:fragment="content">
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card p-3 border-start border-4 border-emerald shadow-sm">
                    <p class="text-muted small mb-1 fw-medium">Thèses Archivées</p>
                    <div class="d-flex align-items-center justify-content-between">
                        <h4 class="fw-bold mb-0">128</h4>
                        <div class="text-emerald opacity-50"><i class="fas fa-boxes-stacked"></i></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3 border-start border-4 border-vibrant shadow-sm">
                    <p class="text-muted small mb-1 fw-medium">À Indexer</p>
                    <div class="d-flex align-items-center justify-content-between">
                        <h4 class="fw-bold mb-0">14</h4>
                        <div class="text-vibrant opacity-50"><i class="fas fa-hourglass-half"></i></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3 border-start border-4 border-mint shadow-sm">
                    <p class="text-muted small mb-1 fw-medium">Dépôts récents</p>
                    <div class="d-flex align-items-center justify-content-between">
                        <h4 class="fw-bold mb-0">7</h4>
                        <div class="text-mint opacity-50"><i class="fas fa-clock-rotate-left"></i></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3 border-start border-4 border-forest shadow-sm">
                    <p class="text-muted small mb-1 fw-medium">Capacité PDF</p>
                    <div class="d-flex align-items-center justify-content-between">
                        <h4 class="fw-bold mb-0">92%</h4>
                        <div class="text-forest opacity-50"><i class="fas fa-database"></i></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card p-4 border-emerald-soft">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h5 class="fw-bold mb-0 text-forest">Indexation & Validation</h5>
                    <p class="small text-muted mb-0">Gestion du flux des thèses et mémoires (PDF)</p>
                </div>
                <button class="btn btn-emerald rounded-pill px-4 shadow-sm">
                    <i class="fas fa-cloud-arrow-up me-2"></i> Nouveau Document
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle border-mint-light">
                    <thead class="bg-mint-soft">
                        <tr>
                            <th class="border-0">Document PDF</th>
                            <th class="border-0">Étudiant</th>
                            <th class="border-0">Date de Dépôt</th>
                            <th class="border-0">Statut Métiers</th>
                            <th class="border-0 text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableTheses">
                        <!-- Chargé dynamiquement -->
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted small">Chargement des dossiers...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <script th:inline="javascript">
            document.addEventListener('DOMContentLoaded', function () {
                loadTheses();

                function loadTheses() {
                    fetch('/api/theses')
                        .then(res => res.json())
                        .then(data => {
                            const tbody = document.getElementById('tableTheses');
                            tbody.innerHTML = '';

                            // On filtre pour n'afficher que ceux en attente ou révision pour l'indexation
                            const pending = data.filter(t => t.status === 'EN_ATTENTE');

                            if (pending.length === 0) {
                                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted small">Aucun dossier en attente de validation.</td></tr>';
                                return;
                            }

                            pending.forEach(t => {
                                tbody.innerHTML += `
                                    <tr>
                                        <td class="border-0">
                                            <div class="d-flex align-items-center">
                                                <div class="p-2 bg-emerald-soft text-emerald rounded-3 me-3">
                                                    <i class="fas fa-file-lines fa-lg"></i>
                                                </div>
                                                <div>
                                                    <span class="d-block fw-bold text-dark small">${t.titre}</span>
                                                    <span class="extra-small text-muted">${t.type} • ${t.annee}</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="border-0 small">${t.etudiant ? t.etudiant.prenom + ' ' + t.etudiant.nom : 'N/A'}</td>
                                        <td class="border-0 small text-muted">${t.dateDeDepot || 'N/A'}</td>
                                        <td class="border-0"><span class="badge bg-warning text-dark border rounded-pill px-3">${t.status}</span></td>
                                        <td class="border-0 text-end">
                                            <button class="btn btn-icon-mint me-2" onclick="processThese(${t.id}, 'rejeter')" title="Rejeter"><i class="fas fa-xmark"></i></button>
                                            <button class="btn btn-icon-emerald" onclick="processThese(${t.id}, 'valider')" title="Valider"><i class="fas fa-check"></i></button>
                                        </td>
                                    </tr>
                                `;
                            });
                        });
                }

                window.processThese = function (id, action) {
                    if (!confirm(`Voulez-vous vraiment ${action} ce dossier ?`)) return;

                    fetch(`/api/theses/${id}/${action}`, { method: 'POST' })
                        .then(res => {
                            if (res.ok) {
                                alert(`Dossier ${action === 'valider' ? 'validé' : 'rejeté'} avec succès !`);
                                loadTheses();
                            } else {
                                alert('Une erreur est survenue.');
                            }
                        });
                }
            });
        </script>
    </div>
</body>

</html>