<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    th:replace="~{layout/base :: html(title='Recherche Avancée | SIGTMA', activePage='search', pageTitle='Recherche Avancée')}">

<head></head>

<body>
    <div th:fragment="content">
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card border-0 shadow-sm rounded-4 p-4">
                    <h5 class="fw-bold text-forest mb-3">Critères de Recherche</h5>
                    <form id="searchForm" class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">Mot-clé (Titre, Étudiant, Encadrant...)</label>
                            <input type="text" id="keyword" class="form-control rounded-pill"
                                placeholder="Entrez un mot-clé...">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small fw-bold">Année</label>
                            <input type="number" id="annee" class="form-control rounded-pill" placeholder="Ex: 2023">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small fw-bold">Type</label>
                            <select id="type" class="form-select rounded-pill">
                                <option value="">Tous</option>
                                <option value="THESE">Thèse</option>
                                <option value="MEMOIRE">Mémoire</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small fw-bold">Statut</label>
                            <select id="status" class="form-select rounded-pill">
                                <option value="">Tous</option>
                                <option value="EN_ATTENTE">En attente</option>
                                <option value="VALIDEE">Validée</option>
                                <option value="REJETEE">Rejetée</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-forest w-100 rounded-pill" onclick="searchTheses()">
                                <i class="fas fa-search me-2"></i> Rechercher
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
            <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                <h6 class="fw-bold mb-0 text-secondary"><i class="fas fa-list me-2"></i>Résultats de la Recherche</h6>
                <div id="resultsCount" class="badge bg-mint-light text-forest rounded-pill px-3 py-2">0 résultats found
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4 text-secondary text-uppercase extra-small fw-bold">ID</th>
                            <th class="text-secondary text-uppercase extra-small fw-bold">Titre</th>
                            <th class="text-secondary text-uppercase extra-small fw-bold">Étudiant</th>
                            <th class="text-secondary text-uppercase extra-small fw-bold">Année</th>
                            <th class="text-secondary text-uppercase extra-small fw-bold">Type</th>
                            <th class="text-secondary text-uppercase extra-small fw-bold">Statut</th>
                            <th class="text-end pe-4 text-secondary text-uppercase extra-small fw-bold">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="7" class="text-center py-5 text-muted">Utilisez les filtres ci-dessus pour
                                lancer une recherche.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <script>
            function searchTheses() {
                const keyword = document.getElementById('keyword').value;
                const annee = document.getElementById('annee').value;
                const type = document.getElementById('type').value;
                const status = document.getElementById('status').value;

                // For now, our backend /api/theses/recherche only supports motCle and date.
                // We will implement client-side filtering on the full list if we don't update backend,
                // OR we can update the backend to support more filters.
                // Let's assume we will update the backend to be truly "Advanced".
                // Current url for now uses /api/theses and we filter client-side for immediate demo.

                fetch('/api/theses')
                    .then(res => res.json())
                    .then(data => {
                        let filtered = data;

                        // Client-side filtering as a fallback/immediate solution
                        if (keyword) {
                            const k = keyword.toLowerCase();
                            filtered = filtered.filter(t =>
                                (t.titre && t.titre.toLowerCase().includes(k)) ||
                                (t.etudiant && (t.etudiant.nom.toLowerCase().includes(k) || t.etudiant.prenom.toLowerCase().includes(k))) ||
                                (t.encadrant && (t.encadrant.nom.toLowerCase().includes(k) || t.encadrant.prenom.toLowerCase().includes(k)))
                            );
                        }
                        if (annee) {
                            filtered = filtered.filter(t => t.annee == annee);
                        }
                        if (type) {
                            filtered = filtered.filter(t => t.type === type);
                        }
                        if (status) {
                            filtered = filtered.filter(t => t.status === status);
                        }

                        renderTable(filtered);
                    });
            }

            function renderTable(data) {
                const tbody = document.getElementById('tableBody');
                const countBadge = document.getElementById('resultsCount');
                tbody.innerHTML = '';
                countBadge.innerText = `${data.length} résultat(s)`;

                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7" class="text-center py-5 text-muted">Aucun résultat trouvé pour ces critères.</td></tr>`;
                    return;
                }

                data.forEach(t => {
                    const statusClass = t.status === 'VALIDEE' ? 'bg-mint-light text-forest' :
                        t.status === 'REJETEE' ? 'bg-danger-subtle text-danger' : 'bg-warning-subtle text-warning';

                    const etudiantName = t.etudiant ? `${t.etudiant.prenom} ${t.etudiant.nom}` : 'N/A';

                    let actionsHtml = `<div class="d-flex justify-content-end gap-2">`;
                    if (t.fichier) {
                        actionsHtml += `<a href="/api/theses/files/${t.fichier}" target="_blank" class="btn btn-sm btn-outline-forest rounded-pill" title="Afficher">
                                            <i class="fas fa-eye"></i>
                                        </a>`;
                        actionsHtml += `<a href="/api/theses/files/${t.fichier}?download=true" class="btn btn-sm btn-forest rounded-pill" title="Télécharger">
                                            <i class="fas fa-download"></i>
                                        </a>`;
                    } else {
                        actionsHtml += `<span class="text-muted small">Aucun fichier</span>`;
                    }
                    actionsHtml += `</div>`;

                    tbody.innerHTML += `
                        <tr class="animate-fade-in">
                            <td class="ps-4 text-muted small">#${t.id}</td>
                            <td>
                                <div class="fw-bold text-dark">${t.titre}</div>
                                <div class="extra-small text-muted">${t.resume ? t.resume.substring(0, 50) + '...' : ''}</div>
                            </td>
                            <td class="small">${etudiantName}</td>
                            <td><span class="badge bg-light text-dark border rounded-pill">${t.annee}</span></td>
                            <td><span class="badge bg-secondary-subtle text-secondary rounded-pill">${t.type}</span></td>
                            <td><span class="badge ${statusClass} rounded-pill">${t.status}</span></td>
                            <td class="pe-4">${actionsHtml}</td>
                        </tr>
                    `;
                });
            }

            // Optional: Initial load
            // document.addEventListener('DOMContentLoaded', searchTheses);
        </script>

        <style>
            .animate-fade-in {
                animation: fadeIn 0.3s ease-in-out;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(5px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        </style>
    </div>
</body>

</html>